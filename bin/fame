#!/usr/bin/env ruby

$LOAD_PATH.push File.expand_path('../../lib', __FILE__)

require 'rubygems'
require 'commander'
require 'colorize'
require 'fame/version'
require 'fame/interface_builder'
require 'fame/XLIFF'

#
# The Fame CLI
#
class FameApplication
  include Commander::Methods

  def run
    program :name, 'Fame'
    program :version, Fame::VERSION
    program :description, 'Replace identifiers within Apple Interface Builder files to use nice keys and descriptions for localization.'
    default_command :localize

    #
    # Default localize command
    #
    command :localize do |c|
      c.syntax = 'fame localize [options]'
      c.description = 'Replaces generated identifiers of the given Interface Builder file(s) and generates .strings files.'
      c.option '--path STRING', String, 'Path to an interface builder file or a folder that contains interface builder files.'

      c.action do |args, options|
        options.default :path => '.'

        files = Fame::InterfaceBuilder.determine_ib_files!(options.path)

        # Generate XLIFF translation files
        language = 'en'
        xliff = Fame::XLIFF.new
        xliff.generate(language)

        ib_nodes = []

        puts "Collecting Interface Builder information for #{files.count} files".blue

      	# Collect IB nodes for each file
      	files.each_with_index do |f, index|
          puts "  ✔︎ ".green + "(#{index+1}/#{files.count}) #{f}".black
      		ib = Fame::InterfaceBuilder.new
          ib_nodes += ib.nodes(f)
      	end

        puts "Updating translation units".blue
        xliff.update_trans_units(language, ib_nodes)

      end
    end

    run!
  end


end

# run application
FameApplication.new.run
